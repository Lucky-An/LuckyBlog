(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-05b8"],{TEjo:function(e,t,r){"use strict";r.d(t,"f",function(){return a}),r.d(t,"b",function(){return s}),r.d(t,"a",function(){return o}),r.d(t,"c",function(){return l}),r.d(t,"d",function(){return n}),r.d(t,"e",function(){return u}),r.d(t,"j",function(){return m}),r.d(t,"g",function(){return p}),r.d(t,"h",function(){return c}),r.d(t,"i",function(){return d});var i=r("t3Un");function a(e){return Object(i.a)({url:"/api/v1/common/admin/images",method:"get",params:e})}function s(e){return Object(i.a)({url:"/api/v1/common/admin/images",method:"delete",data:e})}function o(e){return Object(i.a)({url:"/api/v1/common/admin/images",method:"post",data:e})}function l(e,t){return Object(i.a)({url:"/api/v1/common/admin/images/"+e,method:"patch",data:t})}function n(e){return Object(i.a)({url:"/api/v1/common/admin/images/"+e,method:"get"})}function u(){return Object(i.a)({url:"/api/v1/common/admin/images/tags",method:"get"})}function m(e){return Object(i.a)({url:"/api/v1/common/admin/images/tags",method:"post",data:e})}function p(e,t){return Object(i.a)({url:"/api/v1/common/admin/images/tags/"+e,method:"put",data:t})}function c(e){return Object(i.a)({url:"/api/v1/common/admin/images/tags/"+e,method:"delete"})}function d(e,t,r){return Object(i.a)({url:"/api/v1/common/admin/images/"+e+"/instance",method:"post",data:{operation:t,save:r}})}},ZJzj:function(e,t,r){},od3w:function(e,t,r){"use strict";var i=r("ZJzj");r.n(i).a},pq4H:function(e,t,r){"use strict";r.r(t);var i=r("rerW"),a=r.n(i),s=r("TEjo"),o=r("jJIE"),l=r.n(o),n={components:{},data:function(){var e=this;return{checkList:["vnc"],systemType:[{key:"linux",display_name:"linux"},{key:"windows",display_name:"windows"}],typeData:[{key:"router",name:"路由器"},{key:"firewall",name:"防火墙"},{key:"instance",name:"实例"},{key:"other",name:"其他"}],ruleForm:{name:"",image_type:"",os_type:"",min_disk:0,min_ram:0,image_metadata:"",description:"",username:"",password:"",ssh:null,rdp:null},rules:{name:[{required:!0,message:"请填写镜像名称",trigger:"blur"},{pattern:/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/,message:"镜像名称只能包含汉字、数字、字母、下划线"}],image_type:[{required:!0,message:"请选择镜像类型",trigger:"change"}],os_type:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&""==r?i(new Error("请选择操作系统类型")):i()},trigger:"change"}],username:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&""==r?i(new Error("请输入用户名")):i()},trigger:"blur"}],password:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&""==r?i(new Error("请输入密码")):i()},trigger:"blur"}],sshname:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&e.ruleForm.ssh&&""==e.ruleForm.ssh.username?i(new Error("请输入用户名")):i()},trigger:"blur"}],sshpassword:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&e.ruleForm.ssh&&""==e.ruleForm.ssh.password?i(new Error("请输入密码")):i()},trigger:"blur"}],sshport:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&e.ruleForm.ssh&&""===e.ruleForm.ssh.port?i(new Error("请输入端口")):/^[0-9]*$/.test(e.ruleForm.ssh.port)&&/^(0|[1-9][0-9]*)$/.test(e.ruleForm.ssh.port)?i():i(new Error("格式不正确"))},trigger:"change"}],rdpname:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&e.ruleForm.rdp&&""==e.ruleForm.rdp.username?i(new Error("请输入用户名")):i()},trigger:"blur"}],rdppassword:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&e.ruleForm.rdp&&""==e.ruleForm.rdp.password?i(new Error("请输入密码")):i()},trigger:"blur"}],rdpport:[{required:!0,validator:function(t,r,i){"kvm"==e.ruleForm.image_type&&e.ruleForm.rdp&&""===e.ruleForm.rdp.port?i(new Error("请输入端口")):/^[0-9]*$/.test(e.ruleForm.rdp.port)&&/^(0|[1-9][0-9]*)$/.test(e.ruleForm.rdp.port)?i():i(new Error("格式不正确"))},trigger:"blur"}]},id:this.$route.query.id,origin_id:this.$route.query.origin_id,filename:"",filenameGet:"",chunk:0,allChunk:0,proColor:"success",progress:0,image_uuid:"",cancel:null}},created:function(){this.id&&this.getInfo(),this.origin_id&&(this.ruleForm.image_type="kvm")},beforeRouteLeave:function(e,t,r){var i=this;this.image_uuid?this.$confirm("离开当前页面会导致上传文件失败，确认要离开吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){i.cancel(),r(),i.$message({type:"success",message:"操作成功"})}).catch(function(e){i.$message({type:"success",message:"已取消离开"})}):r()},methods:{checkChange:function(e){e.includes("ssh")?this.ruleForm.ssh||(this.ruleForm.ssh={username:"",password:"",port:""}):this.ruleForm.ssh=null,e.includes("rdp")?this.ruleForm.rdp||(this.ruleForm.rdp={username:"",password:"",port:""}):this.ruleForm.rdp=null},changeFile:function(){var e=this,t=this.$refs.image.files;if(t.length>0){if("kvm"==this.ruleForm.image_type){if(!this.endWith(t[0].name,".qcow2"))return this.$message.error("只能上传.qcow2文件"),this.$refs.image.value="",void(this.filename=this.filenameGet)}else if("docker"==this.ruleForm.image_type){if(![".tar.gz",".tar",".tgz"].some(function(r){return e.endWith(t[0].name,r)}))return this.$message.error("只能上传tar.gz,tar,tgz文件"),this.$refs.image.value="",void(this.filename=this.filenameGet)}this.filename=t[0].name}else this.filename=this.filenameGet},endWith:function(e,t){var r=e.length-t.length;return r>=0&&e.toLowerCase().lastIndexOf(t)==r},uploadImg:function(e){var t=this.$refs.image.files;if(0===t.length)return this.$message.success("操作成功"),void this.$router.push({path:"/image/virtual"});this.image_uuid=e.image_uuid;this.allChunk=Math.floor(t[0].size/10485760),this.chunkUploadFile(t[0],this.chunk,this.image_uuid,10485760)},chunkUploadFile:function(e,t,r,i){var a=this,s=t==this.allChunk?e.size-1:(t+1)*i-1,o=(t==this.allChunk&&e.size,this.axios.CancelToken),n=e.slice(t*i,(t+1)*i);this.axios({url:"/api/v1/admin/upload",method:"post",data:n,params:{image_uuid:r},headers:{"Content-Disposition":'attachment;filename="'+r+'"',"X-CSRF-Token":l.a.get("X-CSRF-Token"),"X-Content-Range":"bytes "+t*i+"-"+s+"/"+e.size,"X-Session-ID":r,"Content-Type":"application/octet-stream"},cancelToken:new o(function(e){a.cancel=e})}).then(function(t){a.chunk++,a.progress=a.chunk/a.allChunk*100|0,200==t.status?(a.image_uuid=null,a.$message.success("操作成功"),a.$router.push({path:"/image/virtual"})):a.chunkUploadFile(e,a.chunk,r,i)})},changeOstype:function(e){this.ruleForm.image_metadata="windows"==e?"disk_bus:ide,vif_type:rtl8139":""},clearData:function(){this.ruleForm.os_type="",this.ruleForm.min_disk=0,this.ruleForm.min_ram=0,this.ruleForm.image_metadata="",this.ruleForm.username="",this.ruleForm.password=""},backView:function(){this.origin_id?this.$router.push({path:"/image/imageFormat"}):this.$router.push({path:"/image/virtual"})},getInfo:function(){var e=this;Object(s.d)(this.id).then(function(t){var r=t.data;if(r.success){for(var i in e.ruleForm)e.ruleForm[i]=r.data[i];var a=r.data.show_name;e.filename=e.filenameGet=a?r.data.show_name+".qcow2":"",e.ruleForm.ssh?e.checkList.push("ssh"):e.ruleForm.ssh=null,e.ruleForm.rdp?e.checkList.push("rdp"):e.ruleForm.rdp=null}})},onSubmit:function(){var e=this;"kvm"===this.ruleForm.image_type&&this.ruleForm.ssh||delete this.ruleForm.ssh,"kvm"===this.ruleForm.image_type&&this.ruleForm.rdp||delete this.ruleForm.rdp,"kvm"===this.ruleForm.image_type&&(this.ruleForm.beats_injection=!0),this.id?Object(s.c)(this.id,this.ruleForm).then(function(t){t.data.success&&e.uploadImg(t.data.data)}):(this.origin_id&&(this.ruleForm.origin_id=this.origin_id),Object(s.a)(this.ruleForm).then(function(t){t.data.success&&e.uploadImg(t.data.data)}))},uploadImage:function(e){var t=this;setTimeout(function(){t.$refs.upload.submit()},0)},submitForm:function(e){var t=this;this.$refs[e].validate(function(e){if(!e)return!1;t.onSubmit()})},initData:function(e){var t={},r=[],i=!0,s=!1,o=void 0;try{for(var l,n=a()(e);!(i=(l=n.next()).done);i=!0){var u=l.value;u.id=String(u.id),t[u.id]=u}}catch(e){s=!0,o=e}finally{try{!i&&n.return&&n.return()}finally{if(s)throw o}}for(var m in t)t[m].parent_id?(t[t[m].parent_id].children||(t[t[m].parent_id].children=[]),t[t[m].parent_id].children.push(t[m])):r.push(t[m]);return r}}},u=(r("od3w"),r("q/B8"),r("ZrdR")),m=Object(u.a)(n,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"app-container create_match"},[r("div",{staticClass:"container_bg",staticStyle:{"padding-top":"50px"}},[r("el-form",{ref:"ruleForm",staticClass:"demo-ruleForm",staticStyle:{width:"1030px",margin:"0 auto"},attrs:{model:e.ruleForm,rules:e.rules,"label-width":"150px"}},[r("el-form-item",{attrs:{label:"镜像名称",prop:"name"}},[r("el-input",{staticClass:"pad_r_45",attrs:{maxlength:"30","show-word-limit":"",placeholder:"请填写镜像名称，只能包含汉字、数字、字母、下划线"},model:{value:e.ruleForm.name,callback:function(t){e.$set(e.ruleForm,"name","string"==typeof t?t.trim():t)},expression:"ruleForm.name"}})],1),e._v(" "),r("el-form-item",{attrs:{label:"上传镜像类型",prop:"image_type"}},[r("el-select",{staticStyle:{width:"100%"},attrs:{disabled:!!e.id||!!e.origin_id,placeholder:"请选择上传镜像格式",clearable:""},on:{change:e.clearData},model:{value:e.ruleForm.image_type,callback:function(t){e.$set(e.ruleForm,"image_type",t)},expression:"ruleForm.image_type"}},[r("el-option",{attrs:{value:"kvm",label:"kvm"}}),e._v(" "),r("el-option",{attrs:{value:"docker",label:"docker"}})],1)],1),e._v(" "),r("el-form-item",{directives:[{name:"show",rawName:"v-show",value:"kvm"==e.ruleForm.image_type,expression:"ruleForm.image_type=='kvm'"}],attrs:{label:"操作系统类型",prop:"os_type"}},[r("el-select",{staticStyle:{width:"100%"},attrs:{clearable:"",placeholder:"请选择操作系统类型"},on:{change:e.changeOstype},model:{value:e.ruleForm.os_type,callback:function(t){e.$set(e.ruleForm,"os_type",t)},expression:"ruleForm.os_type"}},e._l(e.systemType,function(e){return r("el-option",{key:e.key,attrs:{value:e.key,label:e.display_name}})}))],1),e._v(" "),"docker"==e.ruleForm.image_type?r("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[e._v("只能上传tar.gz,tar,tgz文件")]):e._e(),e._v(" "),"kvm"==e.ruleForm.image_type?r("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[e._v("只能上传qcow2文件")]):e._e(),e._v(" "),!e.origin_id&&e.ruleForm.image_type?r("el-form-item",{attrs:{label:"上传文件",required:""}},[r("span",{staticClass:"upload_box"},[r("input",{ref:"image",attrs:{type:"file"},on:{change:e.changeFile}}),e._v(" "),r("el-button",{attrs:{id:"submit",size:"small",type:"primary"}},[e._v(e._s(e.filename?"重新选择":"选择文件"))])],1),e._v(" "),r("div",{staticClass:"des_box"},[r("p",[e._v(e._s(e.filename))]),e._v(" "),"docker"==e.ruleForm.image_type?r("p",[e._v("只能上传tar.gz,tar,tgz文件")]):e._e(),e._v(" "),"kvm"==e.ruleForm.image_type?r("p",[e._v("只能上传qcow2文件")]):e._e()]),e._v(" "),e.allChunk>0?r("div",{staticStyle:{"margin-bottom":"10px"}},[r("el-progress",{attrs:{"text-inside":!0,"stroke-width":24,percentage:e.progress,status:e.proColor}})],1):e._e()]):e._e(),e._v(" "),"kvm"==e.ruleForm.image_type?r("el-form-item",{attrs:{label:"远程连接方式"}},[r("el-checkbox-group",{on:{change:e.checkChange},model:{value:e.checkList,callback:function(t){e.checkList=t},expression:"checkList"}},[r("div",{staticClass:"clearfix"},[r("el-checkbox",{staticStyle:{float:"left"},attrs:{label:"vnc",disabled:""}}),e._v(" "),r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"用户名",prop:"username"}},[r("el-input",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{placeholder:"请输入用户名"},model:{value:e.ruleForm.username,callback:function(t){e.$set(e.ruleForm,"username","string"==typeof t?t.trim():t)},expression:"ruleForm.username"}})],1),e._v(" "),r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"密码",prop:"password"}},[r("el-input",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{type:"text",placeholder:"请输入密码"},model:{value:e.ruleForm.password,callback:function(t){e.$set(e.ruleForm,"password","string"==typeof t?t.trim():t)},expression:"ruleForm.password"}})],1)],1),e._v(" "),r("div",{staticClass:"clearfix",staticStyle:{"margin-top":"20px"}},[r("el-checkbox",{class:{colorFul:"windows"==e.ruleForm.os_type},staticStyle:{float:"left"},attrs:{disabled:"windows"==e.ruleForm.os_type,label:"ssh"}}),e._v(" "),e.ruleForm.ssh?r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"用户名",prop:"sshname"}},[r("el-input",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{placeholder:"请输入用户名"},model:{value:e.ruleForm.ssh.username,callback:function(t){e.$set(e.ruleForm.ssh,"username","string"==typeof t?t.trim():t)},expression:"ruleForm.ssh.username"}})],1):e._e(),e._v(" "),e.ruleForm.ssh?r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"密码",prop:"sshpassword"}},[r("el-input",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{type:"text",placeholder:"请输入密码"},model:{value:e.ruleForm.ssh.password,callback:function(t){e.$set(e.ruleForm.ssh,"password","string"==typeof t?t.trim():t)},expression:"ruleForm.ssh.password"}})],1):e._e(),e._v(" "),e.ruleForm.ssh?r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"端口",prop:"sshport"}},[r("el-input",{staticClass:"numberInput",staticStyle:{width:"100px","margin-right":"5px"},attrs:{placeholder:"请输入端口"},model:{value:e.ruleForm.ssh.port,callback:function(t){e.$set(e.ruleForm.ssh,"port",e._n("string"==typeof t?t.trim():t))},expression:"ruleForm.ssh.port"}})],1):e._e()],1),e._v(" "),r("div",{staticClass:"clearfix",staticStyle:{"margin-top":"20px"}},[r("el-checkbox",{staticStyle:{float:"left"},attrs:{label:"rdp"}}),e._v(" "),e.ruleForm.rdp?r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"用户名",prop:"rdpname"}},[r("el-input",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{placeholder:"请输入用户名"},model:{value:e.ruleForm.rdp.username,callback:function(t){e.$set(e.ruleForm.rdp,"username","string"==typeof t?t.trim():t)},expression:"ruleForm.rdp.username"}})],1):e._e(),e._v(" "),e.ruleForm.rdp?r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"密码",prop:"rdppassword"}},[r("el-input",{staticStyle:{width:"100px","margin-right":"5px"},attrs:{type:"text",placeholder:"请输入密码"},model:{value:e.ruleForm.rdp.password,callback:function(t){e.$set(e.ruleForm.rdp,"password","string"==typeof t?t.trim():t)},expression:"ruleForm.rdp.password"}})],1):e._e(),e._v(" "),e.ruleForm.rdp?r("el-form-item",{staticStyle:{float:"left"},attrs:{"label-width":"90px",label:"端口",prop:"rdpport"}},[r("el-input",{staticClass:"numberInput",staticStyle:{width:"100px","margin-right":"5px"},attrs:{placeholder:"请输入端口"},model:{value:e.ruleForm.rdp.port,callback:function(t){e.$set(e.ruleForm.rdp,"port",e._n("string"==typeof t?t.trim():t))},expression:"ruleForm.rdp.port"}})],1):e._e()],1)])],1):e._e(),e._v(" "),r("el-form-item",{attrs:{label:"镜像描述"}},[r("el-input",{attrs:{type:"textarea",placeholder:"请输入描述","show-word-limit":""},model:{value:e.ruleForm.description,callback:function(t){e.$set(e.ruleForm,"description",t)},expression:"ruleForm.description"}})],1),e._v(" "),r("el-form-item",{staticClass:"from_submit_btn",staticStyle:{"margin-top":"60px"}},[r("el-button",{attrs:{type:"primary"},on:{click:function(t){e.submitForm("ruleForm")}}},[e._v("保存")]),e._v(" "),r("el-button",{attrs:{type:"warning"},on:{click:e.backView}},[e._v("返回")])],1)],1)],1)])},[],!1,null,null,null);m.options.__file="index.vue";t.default=m.exports},"q/B8":function(e,t,r){"use strict";var i=r("zQh6");r.n(i).a},zQh6:function(e,t,r){}}]);